"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),_get=function e(t,n,r){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0!==o){if("value"in o)return o.value;o=o.get;return void 0!==o?o.call(r):void 0}t=Object.getPrototypeOf(t);if(null!==t)return e(t,n,r)};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}jQuery(function(n){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.ajaxurl=e.ajaxurl,t.debug_mode=e.debug_mode,t.order_id=e.order_id,t.transaction_token_nonce=void 0!==e.transaction_token_nonce?e.transaction_token_nonce:"",t.order_requires_payment_upfront=e.order_requires_payment_upfront,t.log_event_script_nonce=e.log_event_script_nonce,t.checkout_js_transaction_id_field_name=e.checkout_js_transaction_id_field_name,t.checkout_js_token_field_name=e.checkout_js_token_field_name,t.i18n=e.i18n,t}window.WC_Elavon_Payment_Form_Handler=(_inherits(r,SV_WC_Payment_Form_Handler_v5_10_4),_createClass(r,[{key:"get_transaction_token",value:function(){var o=this;return new Promise(function(t,r){n.ajax(o.ajaxurl,{data:o.get_transaction_token_data()}).then(function(e){e.success?t(e.data):e.data?r([e.data]):r([o.i18n.general_error])},function(e,t,n){console.error("[Checkout.js]",t,n),r([o.i18n.general_error])})})}},{key:"get_transaction_token_data",value:function(){return{action:"wc_"+this.plugin_id+"_get_transaction_token",security:this.transaction_token_nonce,gateway_id:this.id,order_id:this.order_id,tokenize_payment_method:this.should_tokenize_payment_method(),test_amount:this.get_test_amount()}}},{key:"get_test_amount",value:function(){var e=n("#wc-"+this.id_dasherized+"-test-amount").val();return e&&e.length?e:null}},{key:"get_payment_data",value:function(e){return _extends({},e.payment_data,this.get_payment_method_data(),{ssl_txn_auth_token:e.transaction_token})}},{key:"get_payment_method_data",value:function(){var e={},e=this.get_selected_saved_payment_method()?{ssl_token:this.get_selected_saved_payment_method()}:{ssl_card_number:this.get_card_number(),ssl_exp_date:this.get_credit_card_exp_date()};return _extends({},e,{ssl_cvv2cvc2:this.get_credit_card_csc(),ssl_cvv2cvc2_indicator:this.get_credit_card_csc_indicator()})}},{key:"get_card_number",value:function(){var e=n("#wc-"+this.id_dasherized+"-account-number");return e.val()?e.val().replace(/\s/g,""):""}},{key:"get_credit_card_exp_date",value:function(){var e=n("#wc-"+this.id_dasherized+"-expiry");if(!e.val())return"";e=n.payment.cardExpiryVal(e.val());return("0"+e.month.toString()).slice(-2)+e.year.toString().slice(-2)}},{key:"get_credit_card_csc",value:function(){var e=n("#wc-"+this.id_dasherized+"-csc");return e.val()?e.val():""}},{key:"get_credit_card_csc_indicator",value:function(){return this.get_credit_card_csc()?1:0}},{key:"on_transaction_token_error",value:function(e){this.render_errors(e),this.unblock_ui()}},{key:"on_transaction_token_success",value:function(e){var t=this,e=this.get_payment_data(e);ConvergeEmbeddedPayment.pay(e,{onApproval:function(e){return t.on_transaction_completed(e)},onDeclined:function(e){return t.on_transaction_declined(e)},onError:function(e){return t.on_transaction_error(e)}})}},{key:"should_tokenize_payment_method",value:function(){if(this.get_selected_saved_payment_method())return!1;var e=n("#wc-"+this.id_dasherized+"-tokenize-payment-method");return"checkbox"===e.prop("type")?e.prop("checked"):"hidden"===e.prop("type")&&!!e.val()}},{key:"validate_card_data",value:function(){return this.should_use_saved_payment_method()?_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"validate_card_data",this).call(this):!!this.is_checkout_js_transaction_complete()||(_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"validate_card_data",this).call(this)&&this.start_transaction(),!1)}},{key:"should_use_saved_payment_method",value:function(){return(!this.should_process_payment_upfront()||!this.csc_required_for_tokens)&&!!this.get_selected_saved_payment_method()}},{key:"should_process_payment_upfront",value:function(){var e=this.get_test_amount();return e&&0<e.length?!!parseFloat(e):this.order_requires_payment_upfront}},{key:"get_selected_saved_payment_method",value:function(){return n('[name="wc-'+this.id_dasherized+'-payment-token"]:checked').val()||""}},{key:"is_checkout_js_transaction_complete",value:function(){return!!n("[name="+this.checkout_js_transaction_id_field_name+"]").val()||!!n("[name="+this.checkout_js_token_field_name+"]").val()}},{key:"start_transaction",value:function(){var t=this;if("undefined"==typeof ConvergeEmbeddedPayment)return this.render_errors([this.i18n.general_error]),void console.error("[Checkout.js] ConvergeEmbeddedPayment is not defined.");this.get_transaction_token().then(function(e){return t.on_transaction_token_success(e)},function(e){return t.on_transaction_token_error(e)})}},{key:"on_transaction_error",value:function(e){this.render_errors([e]),this.log_error_response({name:"[Checkout.js] Transaction error",message:e}),this.unblock_ui()}},{key:"on_transaction_completed",value:function(e){e.ssl_txn_id&&n("[name="+this.checkout_js_transaction_id_field_name+"]").val(e.ssl_txn_id),"GETTOKEN"===e.ssl_transaction_type&&e.ssl_token&&n("[name="+this.checkout_js_token_field_name+"]").val(e.ssl_token),(e.ssl_txn_id||e.ssl_token)&&this.form.submit()}},{key:"on_transaction_declined",value:function(e){return e.errorCode?this.on_transaction_error("["+e.errorCode+"] "+e.errorName+": "+e.errorMessage):this.on_transaction_completed(e)}},{key:"log_error_response",value:function(e){console.log(e.name,e.message),this.debug_mode&&(e={action:"wc_"+this.id+"_payment_form_log_script_event",security:this.log_event_script_nonce,name:e.name,message:e.message},n.post(this.ajaxurl,e,function(e){e&&e.success||console.log(e)}))}}]),r),n(document.body).trigger("wc_elavon_payment_form_handler_loaded")});